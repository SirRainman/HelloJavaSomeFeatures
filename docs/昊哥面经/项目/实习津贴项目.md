# 实习项目总结

2020年6-8月，我在阿里巴巴天猫进出口事业群的考拉海购实习，主要负责考拉海购津贴部分的工作。我的主要工作内容分为三块，一是津贴系统的开发与优化，主要包括津贴前台系统和津贴后台系统。二是资损防控工作，主要包括在BCP业务校验平台编写校验规则，在BCP工程中为校验平台编写查询接口。三是迁移工程。

## 前台系统

前台系统查津贴标/领津贴/用津贴/退津贴/津贴明细查询/优惠金额计算等核心链路前台服务；供业务方调用。

津贴派发系统的开发：

接下来介绍一下津贴的派发流程。津贴派发主要有津贴派发流程，津贴验证流程，计数校验流程，风控校验流程和数据持久化流程。
在津贴派发流程中，首先根据津贴ID，渠道ID，用户ID去获取分布式锁，获取失败的话就会直接返回操作太频繁。
接下来如果参数中事务ID不为空的话就会去查询幂等表，以保证幂等性，防止重复派发津贴。
接下来就会进入津贴验证流程，依次判断渠道ID，用户ID是否在黑名单，时间是否在活动时间。
接下来就会进入计数校验流程，这一流程主要是根据派发类型来生成津贴金额，然后依次校验总金额，每日限领金额，用户限领金额是否超过阈值。
接下来就会进入风控流程，调用风控提供的API。
接下来插入数据库，更新派发金额，更新账户余额，记录明细信息，写幂等表。
最后封装返回，并释放分布式锁。

黑名单系统开发：

购物津贴对标的竞品是天猫淘宝双十一购物津贴，采用购物津贴来贯穿整个大促期已经成为电商平台的主流做法。
由于购物津贴的设计就是在大促期使用，因此一个重要的关注点就是项目能抗住多少并发量。我对津贴后台工程针对并发量做了一个优化。原来的津贴黑名单存在热Key问题。原来的key值为schemeId，value为配置所有黑名单商品Id。这样会导致所有并发集中在这一个key上，引发solo限流，从而穿库。虽然后来又在本地用ConcurrentHashMap做缓存，但仍然存在风险隐患。最终的解决方案是拆分key。用商品Id做key，用true/false做value，彻底解决了这一问题。

## 后台系统

津贴后台系统主要是为运营提供创建津贴活动，商家报名津贴活动，津贴商品加入黑名单，发布津贴活动等功能

## 资损防控

### 风险点

作为一个营销工具，津贴的资损防控自然是重点。关注各个风险点，做好资损防控，必须要对津贴的风险点有深入理解。

一致性风险主要是各系统在并发/幂等被突破情况下的资损风险。应对这一风险的主要手段是对各调用服务进行幂等一致性校验。

业务规则规避风险主要是黑产，漏洞规避。在津贴逻辑中对津贴总金额限制、每日发放总金额、单账户每日限领金额进行了计数校验，
缩小风险敞口。津贴使用规则类校验（时间，商品，金额）

资金流平衡性风险主要是商品购买时使用津贴，退单时津贴是否按比例退等。这里可以通过新增BCP规则来校验。

舆论风险 领取及核销津贴时由于系统容量问题导致用户无法操作，引发舆论风险，需要前期预估业务流量，进行适当扩容、限流、压测。

### BCP平台

BCP平台是业务校验平台。MYSQL每次执行SQL语句时都会记录到binlog。BCP平台通过订阅binlog拿到SQL记录，然后泛化调用BCP工程提供的查询接口进行对账，以此来缩小风险敞口。比如拿到一条派发金额的SQL，必须要验证用户限领金额，每日限领金额，津贴派发总金额，这时候就调用BCP工程中的接口，和津贴派发计划的限额比较。如果不符合要求久会在钉钉上报警。